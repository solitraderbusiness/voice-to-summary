import logging
import requests
from config.settings import OPENROUTER_API_KEY

logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

def summarize_text(text):
    try:
        logger.info("Starting summarization")
        headers = {
            "Authorization": f"Bearer {OPENROUTER_API_KEY}",
            "Content-Type": "application/json"
        }
        prompt = f"""
        ฺฏุฒุงุฑุด ูุงู ุฒุฑ ุฑุง ุจู ุตูุฑุช ูฺฉุงุช ฺฉูุฏ ู ุฏูู ุจู ุฒุจุงู ูุงุฑุณ ุฎูุงุตู ฺฉูุฏ. ููุท ุงุทูุงุนุงุช ููุฌูุฏ ุฏุฑ ูุชู ุฑุง ุฎูุงุตู ฺฉูุฏ ู ุงุฒ ุงูุฒูุฏู ุงุทูุงุนุงุช ุฎุงุฑุฌ ุง ุญุฏุณ ู ฺฏูุงู ุฎูุฏุฏุงุฑ ฺฉูุฏ. ุฎูุงุตู ุจุงุฏ ุญุฏูุฏ ณฐฐ ฺฉููู (ฒตฐโณตฐ ฺฉููู) ุจุงุดุฏ ู ุฏุฑ ุณู ุจุฎุด **ุงุทูุงุนุงุช ฺฉู**ุ **ุฑูุฏุงุฏูุง ู ุชุญูู**ุ ู **ุชูุตูโูุง ู ุณูุงู** ุณุงุฒูุงูุฏู ุดูุฏ. ูฺฉุงุช ุฒุฑ ุฑุง ุฑุนุงุช ฺฉูุฏ:
        - ุชุงุฑุฎ ุฐฺฉุฑุดุฏู ุฏุฑ ุงุจุชุฏุง ฺฏุฒุงุฑุด ุฑุง ุฏุฑ ุจุฎุด **ุงุทูุงุนุงุช ฺฉู** ุจุง ุงููุฌ ๐๏ธ ุจุงูุฑุฏ.
        - ุจุฑุง ูุฑ ุงุฏุนุง ุง ูุถุนุช (ูุงููุฏ ุงูุฒุงุด ุงุฑุฒุด ูุนุงููุงุช)ุ ุฏูู ุฐฺฉุฑุดุฏู ุฏุฑ ูุชู ุฑุง ุจุง ุนุจุงุฑุช **ุจู ุฏูู** ุจุงูุฑุฏ.
        - ุงุนุฏุงุฏ (ูุงููุฏ ุฏุฑุตุฏุ ููุชุ ุญุฌู) ุฑุง ุฏููุงู ููุงูโุทูุฑ ฺฉู ุฏุฑ ูุชู ุขูุฏู ฺฏุฒุงุฑุด ฺฉูุฏ (ูุซูุงู ฐูซทณ ุฏุฑุตุฏุ ูู ทต ููุช).
        - ุจุฎุดโูุง ฺฉู ุฏุฑ ูุชู ุจูโุนููุงู **ููู** ุนูุงูุชโฺฏุฐุงุฑ ุดุฏูโุงูุฏุ ุจุง ุฌุฒุฆุงุช ุจุดุชุฑ (ฒโณ ุฌููู) ุชูุถุญ ุฏูุฏ.
        - ุชูุงู ุงุณุงู ุณูุงู ุง ููุงุฏูุง ุฐฺฉุฑุดุฏู (ูุงููุฏ ุจุงูฺฉ ุงูุชุตุงุฏ ูููุ ูููุงุฏ ูุจุงุฑฺฉู) ุฑุง ุฏููุงู ุฏุฑ ุฎูุงุตู ุจุงูุฑุฏ.
        ูุฑ ุจุฎุด ุดุงูู ููุงุท ฺฉูุฏ ุจุง ุฌููุงุช ฺฉูุชุงู (ฑฐโฒฐ ฺฉููู) ุจุงุดุฏุ ูฺฏุฑ ุฏุฑ ููุงุท ููู ฺฉู ูุงุฒ ุจู ุชูุถุญ ุจุดุชุฑ ุฏุงุฑูุฏ. ุงุฒ MarkdownV2 (ููุงุท ฺฉูุฏ ุจุง '- 'ุ ูุชู ููู ุจุง **ุจููุฏ**ุ ุณุฑูุตูโูุง ุจุง ###ุ ูุงุตูู ููุงุณุจ ุจู ุจุฎุดโูุง) ู ุงููุฌโูุง ูุฑุชุจุท (๐ ุจุฑุง ุงูุฒุงุดุ ๐ ุจุฑุง ฺฉุงูุดุ โ๏ธ ุจุฑุง ุฑุณฺฉุ โ ุจุฑุง ุชูุตูุ ๐จ ุจุฑุง ุฑูุฏุงุฏุ ๐๏ธ ุจุฑุง ุชุงุฑุฎุ ๐ ุจุฑุง ุงุนุฏุงุฏุ ๐ก ุจุฑุง ูฺฉุงุช ููู) ุงุณุชูุงุฏู ฺฉูุฏ. ุฎูุงุตู ุจุงุฏ ุฎูุงูุงุ ุญุฑููโุงุ ู ุฌุฐุงุจ ุจุงุดุฏ.

        ฺฏุฒุงุฑุด: {text}
        """
        payload = {
            "model": "openai/gpt-4.1-mini",
            "messages": [
                {"role": "user", "content": prompt}
            ],
            "max_tokens": 1500,  # For ~300 words
            "temperature": 0.0  # For fidelity
        }
        response = requests.post(
            "https://openrouter.ai/api/v1/chat/completions",
            headers=headers,
            json=payload
        )

        if response.status_code == 200:
            summary = response.json()["choices"][0]["message"]["content"].strip()
            logger.info(f"Summarization successful: {summary}")
            return summary
        else:
            error = response.text
            logger.error(f"Summarization error: {error}")
            return f"Summarization error: {error}"
    except Exception as e:
        logger.error(f"Summarization error: {str(e)}", exc_info=True)
        return f"Summarization error: {str(e)}"
